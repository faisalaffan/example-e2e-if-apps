{"version":3,"file":"uiautomator2.js","names":["_lodash","_interopRequireDefault","require","_driver","_asyncbox","_appiumUiautomator2Server","_support","_bluebird","_helpers","_axios","_path","REQD_PARAMS","SERVER_LAUNCH_TIMEOUT","SERVER_INSTALL_RETRIES","SERVICES_LAUNCH_TIMEOUT","SERVER_PACKAGE_ID","exports","SERVER_TEST_PACKAGE_ID","INSTRUMENTATION_TARGET","instrumentationLogger","logger","getLogger","UIA2Proxy","JWProxy","proxyCommand","url","method","body","didInstrumentationExit","errors","InvalidContextError","UiAutomator2Server","constructor","log","opts","req","util","hasValue","Error","disableSuppressAccessibilityService","proxyOpts","server","host","port","systemPort","keepAlive","readTimeout","timeout","jwproxy","proxyReqRes","bind","command","prepareServerPackage","appPath","appId","tmpRoot","resultInfo","wasSigned","installState","adb","APP_INSTALL_STATE","NOT_INSTALLED","checkApkCert","helpers","isWriteable","warn","dstPath","path","resolve","basename","fs","copyFile","signApp","isAppInstalled","SAME_VERSION_INSTALLED","getApplicationInstallState","installServerApk","installTimeout","tempDir","openDir","packagesInfo","B","all","apkPath","testApkPath","map","debug","JSON","stringify","shouldUninstallServerPackages","some","every","shouldInstallServerPackages","OLDER_VERSION_INSTALLED","includes","info","silentUninstallPkg","pkgId","uninstallApk","err","message","installPkg","pkgPath","install","noIncremental","replace","timeoutCapName","rimraf","verifyServicesAvailability","isPmServiceAvailable","pmOutput","pmError","waitForCondition","shell","e","waitMs","intervalMs","error","line","split","startSession","caps","cleanupAutomationLeftovers","skipServerInstallation","serverVersion","uiautomator2ServerLaunchTimeout","timer","timing","Timer","start","retries","maxRetries","delayBetweenRetries","startInstrumentationProcess","errorAndThrow","delay","getDuration","asMilliSeconds","toFixed","capabilities","firstMatch","alwaysMatch","cmd","disableWindowAnimation","push","_","isBoolean","instrumentationProcess","createSubProcess","on","stdout","stderr","output","trim","code","deleteSession","strictCleanup","value","axios","data","activeSessionIds","id","filter","Boolean","length","pluralize","delete","forceStop","ignore","killProcessesByName","_default","default"],"sources":["../../lib/uiautomator2.js"],"sourcesContent":["import _ from 'lodash';\nimport { JWProxy, errors } from 'appium/driver';\nimport { waitForCondition } from 'asyncbox';\nimport {\n  SERVER_APK_PATH as apkPath,\n  TEST_APK_PATH as testApkPath,\n  version as serverVersion\n} from 'appium-uiautomator2-server';\nimport {\n  util, logger, tempDir, fs, timing\n} from 'appium/support';\nimport B from 'bluebird';\nimport helpers from './helpers';\nimport axios from 'axios';\nimport path from 'path';\n\nconst REQD_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'disableWindowAnimation'];\nconst SERVER_LAUNCH_TIMEOUT = 30000;\nconst SERVER_INSTALL_RETRIES = 20;\nconst SERVICES_LAUNCH_TIMEOUT = 30000;\nconst SERVER_PACKAGE_ID = 'io.appium.uiautomator2.server';\nconst SERVER_TEST_PACKAGE_ID = `${SERVER_PACKAGE_ID}.test`;\nconst INSTRUMENTATION_TARGET = `${SERVER_TEST_PACKAGE_ID}/androidx.test.runner.AndroidJUnitRunner`;\nconst instrumentationLogger = logger.getLogger('Instrumentation');\n\nclass UIA2Proxy extends JWProxy {\n  async proxyCommand (url, method, body = null) {\n    if (this.didInstrumentationExit) {\n      throw new errors.InvalidContextError(\n        `'${method} ${url}' cannot be proxied to UiAutomator2 server because ` +\n        'the instrumentation process is not running (probably crashed). ' +\n        'Check the server log and/or the logcat output for more details');\n    }\n    return await super.proxyCommand(url, method, body);\n  }\n}\n\nclass UiAutomator2Server {\n  constructor (log, opts = {}) {\n    for (let req of REQD_PARAMS) {\n      if (!opts || !util.hasValue(opts[req])) {\n        throw new Error(`Option '${req}' is required!`);\n      }\n      this[req] = opts[req];\n    }\n    this.log = log;\n    this.disableSuppressAccessibilityService = opts.disableSuppressAccessibilityService;\n    const proxyOpts = {\n      log,\n      server: this.host,\n      port: this.systemPort,\n      keepAlive: true,\n    };\n    if (opts.readTimeout && opts.readTimeout > 0) {\n      proxyOpts.timeout = opts.readTimeout;\n    }\n    this.jwproxy = new UIA2Proxy(proxyOpts);\n    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);\n    this.proxyCommand = this.jwproxy.command.bind(this.jwproxy);\n    this.jwproxy.didInstrumentationExit = false;\n  }\n\n  async prepareServerPackage(appPath, appId, tmpRoot) {\n    const resultInfo = {\n      wasSigned: false,\n      installState: this.adb.APP_INSTALL_STATE.NOT_INSTALLED,\n      appPath,\n      appId,\n    };\n\n    if (await this.adb.checkApkCert(resultInfo.appPath, appId)) {\n      resultInfo.wasSigned = true;\n    } else {\n      if (!await helpers.isWriteable(appPath)) {\n        this.log.warn(\n          `Server package at '${appPath}' is not writeable. ` +\n          `Will copy it into the temporary location at '${tmpRoot}' as a workaround. ` +\n          `Consider making this file writeable manually in order to improve the performance of session startup.`\n        );\n        const dstPath = path.resolve(tmpRoot, path.basename(appPath));\n        await fs.copyFile(appPath, dstPath);\n        resultInfo.appPath = dstPath;\n      }\n      await helpers.signApp(this.adb, resultInfo.appPath);\n    }\n\n    if (appId === SERVER_TEST_PACKAGE_ID && await this.adb.isAppInstalled(appId)) {\n      // There is no point in getting the state for the test server,\n      // since it does not contain any version info\n      resultInfo.installState = this.adb.APP_INSTALL_STATE.SAME_VERSION_INSTALLED;\n    } else if (appId === SERVER_PACKAGE_ID) {\n      resultInfo.installState = await this.adb.getApplicationInstallState(resultInfo.appPath, appId);\n    }\n\n    return resultInfo;\n  }\n\n  /**\n   * Installs the apks on to the device or emulator.\n   *\n   * @param {number} installTimeout - Installation timeout\n   */\n  async installServerApk (installTimeout = SERVER_INSTALL_RETRIES * 1000) {\n    const tmpRoot = await tempDir.openDir();\n    try {\n      const packagesInfo = await B.all(\n        [\n          {\n            appPath: apkPath,\n            appId: SERVER_PACKAGE_ID,\n          }, {\n            appPath: testApkPath,\n            appId: SERVER_TEST_PACKAGE_ID,\n          },\n        ].map(({appPath, appId}) => this.prepareServerPackage(appPath, appId, tmpRoot))\n      );\n\n      this.log.debug(`Server packages status: ${JSON.stringify(packagesInfo)}`);\n      // We want to enforce uninstall in case the current server package has not been signed properly\n      // or if any of server packages is not installed, while the other does\n      const shouldUninstallServerPackages = packagesInfo.some(({wasSigned}) => !wasSigned)\n        || (packagesInfo.some(({installState}) => installState === this.adb.APP_INSTALL_STATE.NOT_INSTALLED)\n            && !packagesInfo.every(({installState}) => installState === this.adb.APP_INSTALL_STATE.NOT_INSTALLED));\n      // Install must always follow uninstall. Also, perform the install if\n      // any of server packages is not installed or is outdated\n      const shouldInstallServerPackages = shouldUninstallServerPackages || packagesInfo.some(({installState}) => [\n        this.adb.APP_INSTALL_STATE.NOT_INSTALLED,\n        this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED,\n      ].includes(installState));\n      this.log.info(`Server packages are ${shouldInstallServerPackages ? '' : 'not '}going to be (re)installed`);\n      if (shouldInstallServerPackages && shouldUninstallServerPackages) {\n        this.log.info('Full packages reinstall is going to be performed');\n      }\n      if (shouldUninstallServerPackages) {\n        const silentUninstallPkg = async (pkgId) => {\n          try {\n            await this.adb.uninstallApk(pkgId);\n          } catch (err) {\n            this.log.info(`Cannot uninstall '${pkgId}': ${err.message}`);\n          }\n        };\n        await B.all(packagesInfo.map(({appId}) => silentUninstallPkg(appId)));\n      }\n      if (shouldInstallServerPackages) {\n        const installPkg = async (pkgPath) => {\n          await this.adb.install(pkgPath, {\n            noIncremental: true,\n            replace: true,\n            timeout: installTimeout,\n            timeoutCapName: 'uiautomator2ServerInstallTimeout'\n          });\n        };\n        await B.all(packagesInfo.map(({appPath}) => installPkg(appPath)));\n      }\n    } finally {\n      await fs.rimraf(tmpRoot);\n    }\n\n    await this.verifyServicesAvailability();\n  }\n\n  async verifyServicesAvailability () {\n    this.log.debug(`Waiting up to ${SERVICES_LAUNCH_TIMEOUT}ms for services to be available`);\n    let isPmServiceAvailable = false;\n    let pmOutput = '';\n    let pmError = null;\n    try {\n      await waitForCondition(async () => {\n        if (!isPmServiceAvailable) {\n          pmError = null;\n          pmOutput = '';\n          try {\n            pmOutput = await this.adb.shell(['pm', 'list', 'instrumentation']);\n          } catch (e) {\n            pmError = e;\n          }\n          if (pmOutput.includes('Could not access the Package Manager')) {\n            pmError = new Error(`Problem running Package Manager: ${pmOutput}`);\n            pmOutput = ''; // remove output, so it is not printed below\n          } else if (pmOutput.includes(INSTRUMENTATION_TARGET)) {\n            pmOutput = ''; // remove output, so it is not printed below\n            this.log.debug(`Instrumentation target '${INSTRUMENTATION_TARGET}' is available`);\n            // eslint-disable-next-line require-atomic-updates\n            isPmServiceAvailable = true;\n          } else if (!pmError) {\n            pmError = new Error('The instrumentation target is not listed by Package Manager');\n          }\n        }\n        return isPmServiceAvailable;\n      }, {\n        waitMs: SERVICES_LAUNCH_TIMEOUT,\n        intervalMs: 1000,\n      });\n    } catch (err) {\n      this.log.error(`Unable to find instrumentation target '${INSTRUMENTATION_TARGET}': ${(pmError || {}).message}`);\n      if (pmOutput) {\n        this.log.debug('Available targets:');\n        for (const line of pmOutput.split('\\n')) {\n          this.log.debug(`    ${line.replace('instrumentation:', '')}`);\n        }\n      }\n    }\n  }\n\n  async startSession (caps) {\n    await this.cleanupAutomationLeftovers();\n    if (caps.skipServerInstallation) {\n      this.log.info(`'skipServerInstallation' is set. Attempting to use UIAutomator2 server from the device`);\n    } else {\n      this.log.info(`Starting UIAutomator2 server ${serverVersion}`);\n      this.log.info(`Using UIAutomator2 server from '${apkPath}' and test from '${testApkPath}'`);\n    }\n\n    const timeout = caps.uiautomator2ServerLaunchTimeout || SERVER_LAUNCH_TIMEOUT;\n    const timer = new timing.Timer().start();\n    let retries = 0;\n    const maxRetries = 2;\n    const delayBetweenRetries = 3000;\n    while (retries < maxRetries) {\n      this.log.info(`Waiting up to ${timeout}ms for UiAutomator2 to be online...`);\n      this.jwproxy.didInstrumentationExit = false;\n      await this.startInstrumentationProcess();\n      if (!this.jwproxy.didInstrumentationExit) {\n        try {\n          await waitForCondition(async () => {\n            try {\n              await this.jwproxy.command('/status', 'GET');\n              return true;\n            } catch (err) {\n              // short circuit to retry or fail fast\n              return this.jwproxy.didInstrumentationExit;\n            }\n          }, {\n            waitMs: timeout,\n            intervalMs: 1000,\n          });\n        } catch (err) {\n          this.log.errorAndThrow(`The instrumentation process cannot be initialized within ${timeout}ms timeout. `\n            + 'Make sure the application under test does not crash and investigate the logcat output. '\n            + `You could also try to increase the value of 'uiautomator2ServerLaunchTimeout' capability`);\n        }\n      }\n      if (!this.jwproxy.didInstrumentationExit) {\n        break;\n      }\n\n      retries++;\n      if (retries >= maxRetries) {\n        this.log.errorAndThrow('The instrumentation process cannot be initialized. '\n          + 'Make sure the application under test does not crash and investigate the logcat output.');\n      }\n      this.log.warn(`The instrumentation process has been unexpectedly terminated. `\n        + `Retrying UiAutomator2 startup (#${retries} of ${maxRetries - 1})`);\n      await this.cleanupAutomationLeftovers(true);\n      await B.delay(delayBetweenRetries);\n    }\n\n    this.log.debug(`The initialization of the instrumentation process took `\n      + `${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);\n    await this.jwproxy.command('/session', 'POST', {\n      capabilities: {\n        firstMatch: [caps],\n        alwaysMatch: {},\n      }\n    });\n  }\n\n  async startInstrumentationProcess () {\n    const cmd = ['am', 'instrument', '-w'];\n    if (this.disableWindowAnimation) {\n      cmd.push('--no-window-animation');\n    }\n    if (_.isBoolean(this.disableSuppressAccessibilityService)) {\n      cmd.push('-e', 'DISABLE_SUPPRESS_ACCESSIBILITY_SERVICES', this.disableSuppressAccessibilityService);\n    }\n    // Disable Google analytics to prevent possible fatal exception\n    cmd.push('-e', 'disableAnalytics', true);\n    cmd.push(INSTRUMENTATION_TARGET);\n    const instrumentationProcess = this.adb.createSubProcess(['shell', ...cmd]);\n    instrumentationProcess.on('output', (stdout, stderr) => {\n      const output = _.trim(stdout || stderr);\n      if (output) {\n        instrumentationLogger.debug(output);\n      }\n    });\n    instrumentationProcess.on('exit', (code) => {\n      instrumentationLogger.debug(`The process has exited with code ${code}`);\n      this.jwproxy.didInstrumentationExit = true;\n    });\n    await instrumentationProcess.start(0);\n  }\n\n  async deleteSession () {\n    this.log.debug('Deleting UiAutomator2 server session');\n    // rely on jwproxy's intelligence to know what we're talking about and\n    // delete the current session\n    try {\n      await this.jwproxy.command('/', 'DELETE');\n    } catch (err) {\n      this.log.warn(`Did not get confirmation UiAutomator2 deleteSession worked; ` +\n          `Error was: ${err}`);\n    }\n  }\n\n  async cleanupAutomationLeftovers (strictCleanup = false) {\n    this.log.debug(`Performing ${strictCleanup ? 'strict' : 'shallow'} cleanup of automation leftovers`);\n\n    try {\n      const {value} = (await axios({\n        url: `http://${this.host}:${this.systemPort}/sessions`,\n        timeout: 500,\n      })).data;\n      const activeSessionIds = value.map(({id}) => id).filter(Boolean);\n      if (activeSessionIds.length) {\n        this.log.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);\n        this.log.debug(`Cleaning up ${util.pluralize('obsolete session', activeSessionIds.length, true)}`);\n        await B.all(activeSessionIds\n          .map((id) => axios.delete(`http://${this.host}:${this.systemPort}/session/${id}`))\n        );\n        // Let all sessions to be properly terminated before continuing\n        await B.delay(1000);\n      } else {\n        this.log.debug('No obsolete sessions have been detected');\n      }\n    } catch (e) {\n      this.log.debug(`No obsolete sessions have been detected (${e.message})`);\n    }\n\n    try {\n      await this.adb.forceStop(SERVER_TEST_PACKAGE_ID);\n    } catch (ignore) {}\n    if (!strictCleanup) {\n      return;\n    }\n    // https://github.com/appium/appium/issues/10749\n    try {\n      await this.adb.killProcessesByName('uiautomator');\n    } catch (ignore) {}\n  }\n}\n\nexport { UiAutomator2Server, INSTRUMENTATION_TARGET, SERVER_PACKAGE_ID, SERVER_TEST_PACKAGE_ID };\nexport default UiAutomator2Server;\n"],"mappings":"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"}